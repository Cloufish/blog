<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Setting up Hashicorp Vault to manage our Github Token" /><meta property="og:locale" content="en" /><meta name="description" content="UPDATE: This blog post is about managing secrets to authenticate to GitHub via HTTPS connection. But you can also authenticate via SSH connection and generate your own private key as described here. This solution may be more comfortable, because you’re not even prompted for any credentials." /><meta property="og:description" content="UPDATE: This blog post is about managing secrets to authenticate to GitHub via HTTPS connection. But you can also authenticate via SSH connection and generate your own private key as described here. This solution may be more comfortable, because you’re not even prompted for any credentials." /><link rel="canonical" href="https://cloufish.github.io/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/" /><meta property="og:url" content="https://cloufish.github.io/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/" /><meta property="og:site_name" content="Cloufish’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-19T07:46:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Setting up Hashicorp Vault to manage our Github Token" /><meta name="twitter:site" content="@Cloufisz" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"UPDATE: This blog post is about managing secrets to authenticate to GitHub via HTTPS connection. But you can also authenticate via SSH connection and generate your own private key as described here. This solution may be more comfortable, because you’re not even prompted for any credentials.","url":"https://cloufish.github.io/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/","@type":"BlogPosting","headline":"Setting up Hashicorp Vault to manage our Github Token","dateModified":"2021-06-11T19:18:37+02:00","datePublished":"2021-04-19T07:46:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://cloufish.github.io/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/"},"@context":"https://schema.org"}</script><title>Setting up Hashicorp Vault to manage our Github Token | Cloufish's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/blog/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/blog/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Cloufish's Blog"><meta name="application-name" content="Cloufish's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/blog/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/blog/assets/js/dist/post.min.js"></script> <script defer src="/blog/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/blog/" alt="avatar" class="mx-auto"> <img src="/blog/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/blog/">Cloufish's Blog</a></div><div class="site-subtitle font-italic">My own internet corner :)</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blog/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/blog/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/blog/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/blog/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/blog/resources/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>RESOURCES TO LEARN HACKING</span> </a><li class="nav-item"> <a href="/blog/contribute/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>HELP ME WITH GITHUB PROJECTS</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Cloufish" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/Cloufisz" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cloufisz','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/blog/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog/"> Posts </a> </span> <span>Setting up Hashicorp Vault to manage our Github Token</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Setting up Hashicorp Vault to manage our Github Token</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Bartholomew Mokrzycki </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 19, 2021, 7:46 AM +0200" prep="on" > Apr 19 <i class="unloaded">2021-04-19T07:46:00+02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Jun 11, 2021, 7:18 PM +0200" prefix="Updated " > Jun 11 <i class="unloaded">2021-06-11T19:18:37+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2033 words">11 min</span></div></div><div class="post-content"><blockquote><p>UPDATE: This blog post is about managing secrets to authenticate to GitHub via HTTPS connection. But you can also authenticate via SSH connection and generate your own private key as described <a href="https://stackoverflow.com/questions/6565357/git-push-requires-username-and-password">here</a>. This solution may be more comfortable, because you’re not even prompted for <strong>any</strong> credentials.</p></blockquote><h2 id="intro">Intro</h2><p>If you’re working with GitHub/git you may have noticed that you got an e-mail which informs you about a <em>*Deprecation of Username:Password authentication via git in favor of authentication of Username:Token by the end of *12th August</em></p><p>And you’ve probably got the links below to generate new API Github Token as well as why they want you to do that:</p><ul><li><p>https://github.blog/2020-12-15-token-authentication-requirements-for-git-operations/</p><li><p>https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token</p></ul><p>It’s a trivial thing to do, so I’ll skip the process of generating the Token.</p><p>Some of you might be thinking on how to exactly store this Token securely?</p><h2 id="how-tokenssecrets-should-be-kept-secret">How tokens/secrets should be kept <strong>secret</strong>:</h2><h3 id="level-0---hardcoded">Level 0 - Hardcoded:</h3><p>Definitely they shouldn’t be hard-coded into our scripts, application code - This shouldn’t even take place.</p><h3 id="level-1-putted-in-config-file">Level 1 Putted in config file:</h3><p>Putting them into a config file - like when assigning them into an Environment Variable e.g. <code class="language-plaintext highlighter-rouge">GITHUB_TOKEN=gkw4k4uk5jkwrkf3k0j60fk23gksmbs</code>is also a bad idea, because a bad actor might still read these token when accessed to our machine, or even worse - we could accidentally push this config file into a public repository, because we didn’t include this file into <code class="language-plaintext highlighter-rouge">.gitignore</code>.</p><h3 id="level-2---encrypted-keys-in-config-filecode">Level 2 - Encrypted keys in config file/code:</h3><p>If we need to push these keys into our repository, then they should definitely be encrypted</p><p>We can encrypt these keys with OpenSSL</p><p>But the process of decrypting these keys might be troublesome and tiring to an ordinary developer.</p><p>And also it puts the question - <strong>Where to store the encryption key?</strong></p><ul><li><strong>If you wanted simplicity</strong>, then you probably put these <strong>encryption keys into a one file</strong>. This though poses a risk of over-privileged access, because a person that wants to access only one key now has the access to all of them<li>If you put these keys into different files, now you’d have bigger complexity and many of people would get frustrated of doing such a ‘simple security thing’.</ul><h3 id="level-3---moving-the-secrets-to-dedicated-server-secret-manager">Level 3 - Moving the secrets to dedicated server secret manager</h3><ul><li>But creating your own crypto system has a lot of risks of not implementing it correctly. Just like the saying goes <code class="language-plaintext highlighter-rouge">You shouldn't write your own crypto</code> it can also apply to <code class="language-plaintext highlighter-rouge">You shouldn't write your own crypto-server</code><li>You would probably use Cloud Service providers to manage your keys such as <strong>Azure Key Vault</strong> <strong>AWS KMS</strong><li>This will provide a high liability on who accessed these secrets and functionality<h3 id="level-4---hashicorp-vault-temporary-credentials">Level 4 - Hashicorp Vault (Temporary Credentials)</h3><li>If the secret is stolen/disclosed/leaked then after a while It won’t be valid<li>It grants you a credentials/secrets and then after a while it revokes these credentials<h2 id="development-vs-production-environment">Development vs Production environment:</h2></ul><p>When thinking about managing key/tokens/secrets we should take into consideration on where they will appear.</p><p>In our case — We need to store Github Token ID in our Development Environment, so We could probably stay save at level 1 (If we didn’t push the config file accidentally)</p><h2 id="why-still-proceed-further-above-level-1">Why still proceed further ‘above’ level 1?</h2><ul><li>To learn. - That’s basically it.</ul><h2 id="1-installing-vault">#1 Installing Vault</h2><ul><li>For this I recommend you head into <a href="https://www.vaultproject.io/downloads">Hashicorp Vault Installation Docs</a>. I’m on arch linux so a command <code class="language-plaintext highlighter-rouge">sudo pacman -Syu vault</code> is enough for me to install vault</ul><h2 id="2-turning-on-vault-server">#2 Turning on Vault server</h2><ul><li>With command <code class="language-plaintext highlighter-rouge">vault server -dev</code> After executing this command, we’ll see an important information for further configuration <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://imgur.com/DUq7Q01.png" alt="information" /></ul><h2 id="3-assigning-vault_token-and-vault_addr">#3 Assigning $VAULT_TOKEN and $VAULT_ADDR</h2><p>We need to overwrite these tokens with commands: <code class="language-plaintext highlighter-rouge">export VAULT_ADDR='http://127.0.0.1:8200'</code> and also your token with <code class="language-plaintext highlighter-rouge">export VAULT_TOKEN="&lt;ROOT_TOKEN_HERE&gt;"</code><br /> Hashicorp <code class="language-plaintext highlighter-rouge">vault</code> command uses its own API, If we wouldn’t assign the $VAULT_ADDR, then every API request would be done with <strong>https</strong> protocol. Every request like that won’t work, because we only run localhost environment with <strong>http</strong> protocol <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://imgur.com/tZKUoiB.png" alt="error" /></p><h2 id="4-logging-in-to-vault">#4 Logging in to vault</h2><p>With command <code class="language-plaintext highlighter-rouge">vault login</code></p><p>We could accomplish the same thing without the prompt with the help of piping our $ROOT_TOKEN <code class="language-plaintext highlighter-rouge">echo $VAULT_TOKEN | vault login -</code></p><h2 id="setting-up-usernamepassword-based-authentication">Setting up Username:password based authentication</h2><p>Logging in with root token can be troublesome, especially if we don’t need this many permissions in our daily usage. So let’s set up different authentication method called <em>userpass</em> with these steps:</p><h3 id="1-setting-up-vault_addr-and-vault_token-as-previously">1. Setting up $VAULT_ADDR and $VAULT_TOKEN as previously</h3><h3 id="2-login-with-vault-login">2. Login with <code class="language-plaintext highlighter-rouge">vault login</code></h3><h3 id="3-enabling-userpass">3. Enabling userpass</h3><ul><li><code class="language-plaintext highlighter-rouge">vault auth enable userpass</code><blockquote><p><em>TIP</em> - You can always execute command <code class="language-plaintext highlighter-rouge">vault path-help auth/userpass</code> to get further info on how to use this auth method This is so awesome, because It also tells us that we can implement Multi-Factor-Implementation - that’s crazy! Also it tells us how to reset a password, update their policies and which users can authenticate</p><h3 id="4-creating-user">4. Creating user</h3></blockquote><li><code class="language-plaintext highlighter-rouge">vault write auth/userpass/users/&lt;YOUR_CHOSEN_USERNAME&gt; password=&lt;YOUR_CHOSEN_PASSWORD&gt;</code> To create an user<blockquote><p>We can confirm if we managed to add a new user with <code class="language-plaintext highlighter-rouge">vault list/userpass/users</code> command</p><ol><li>We could login now with: <code class="language-plaintext highlighter-rouge">vault login -method=userpass --username=&lt;YOUR_CHOSEN_USERNAME&gt;</code> command, but hang on! Because we won’t be able to access our $GITHUB (TOKEN), because we don’t have as a new created user permission to read them! Firstly we should create this policy</ol></blockquote></ul><h3 id="5-writing-a-policy-to-access-our-secrets-in-secret-vault">5. Writing a policy to access our secrets in secret/ vault</h3><p>The command syntax to write a new policy is:</p><ul><li><code class="language-plaintext highlighter-rouge">vault policy write [name_of_new_policy] [policy_file.hcl]</code> So it requires a [policy_file] which we apparently do not have. Let’s write it then.<pre><code class="language-github.hcl```:">
</code></pre><p>path “secret/*” { capabilities = [“read”, “list”] } ``` That’s seriously it for our use case! :D. We allow read and list operations. Let’s write it with command:</p><li><code class="language-plaintext highlighter-rouge">vault policy write github github.hcl</code></ul><blockquote><p><strong>If you encounter any parsing issues this the command above, use:</strong></p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="err">vault</span><span class="w"> </span><span class="err">policy</span><span class="w"> </span><span class="err">write</span><span class="w"> </span><span class="err">github</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&lt;&lt;</span><span class="w"> </span><span class="err">EOF</span><span class="w">
</span><span class="err">path</span><span class="w"> </span><span class="s2">"secret/*"</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">capabilities</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"read"</span><span class="p">,</span><span class="w"> </span><span class="s2">"list"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">EOF</span><span class="w">
</span></pre></table></code></div></div><p>And now let’s assign this policy to our account: <code class="language-plaintext highlighter-rouge">vault write auth/userpass/users/&lt;YOUR_CHOSEN_USERNAME&gt; password=&lt;YOUR_CHOSEN_PASSWORD&gt; policies=github</code></p></blockquote><p>Now, I know you want to login and test it out!, But let’s add those secrets first! (Because as the unprivileged user we won’t have this luxury! :P)</p><h2 id="5-putting-your-github-key-to-hashicorp-vault">#5 Putting your Github key to Hashicorp Vault</h2><p>with: <code class="language-plaintext highlighter-rouge">vault kv put secret/email key=&lt;YOUR_EMAIL_HERE&gt;</code></p><p>Also, I want to add secret called <strong>email</strong>. Now, many of you might argue if it’s really a secret… I’d be using it in shell scripts, so I think I’ll recognize it as a secret</p><p><code class="language-plaintext highlighter-rouge">vault kv put secret/email key=&lt;YOUR_TOKEN_HERE&gt;</code></p><h2 id="6-logging-in-and-testing-these-policies">#6 Logging in and testing these policies!</h2><p>Now lets login with: <code class="language-plaintext highlighter-rouge">vault login -method=userpass --username=&lt;YOUR_CHOSEN_USERNAME&gt;</code></p><p>Now - <strong>the important part</strong> is to overwrite our VAULT_TOKEN variable with the user token.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://imgur.com/tYpNEf4.png" alt="user_token" /></p><p>We can see the big <strong>WARNING!</strong> there. Essentially if we won’t switch then we would still be interacting with the Hashicorp’s API with our root token.</p><p>If you’ve done everything correctly then you’ve got the Hashicorp Vault set-up!</p><h2 id="7-migrating-dev-environment-to-production">#7 Migrating Dev Environment to ‘Production’</h2><p>Now that we’ve seen the process of configuration, let’s begin to work with non-dev Hashicorp’s vault environment, there are several reasons to do that:</p><ul><li>The Dev environment runs in ‘unsealed’ state by default - This essentially means that all the secrets are decrypted at the start of the vault.<li>Dev environment also runs with storage in-memory. Meaning that it offers no persistence to the secrets We’re storing. All data is lost when Vault or the machine on which it is running is restarted.</ul><p>The whole process is explained in Hashicorp Vault’s Docs about <a href="https://learn.hashicorp.com/tutorials/vault/getting-started-deploy">Deploying</a></p><h3 id="1-writing-confighcl">1. Writing config.hcl</h3><p>I’ve prepared one with following contents:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="err">storage</span><span class="w"> </span><span class="s2">"file"</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">path</span><span class="w">    </span><span class="err">=</span><span class="w"> </span><span class="s2">"/mnt/vault/data"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">listener</span><span class="w"> </span><span class="s2">"tcp"</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">address</span><span class="w">     </span><span class="err">=</span><span class="w"> </span><span class="s2">"127.0.0.1:8200"</span><span class="w">
  </span><span class="err">tls_disable</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="err">api_addr</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"http://127.0.0.1:8200"</span><span class="w">
</span><span class="err">ui</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="kc">true</span><span class="w">

</span></pre></table></code></div></div><p>I’m using file system storage backend with</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="err">storage</span><span class="w"> </span><span class="s2">"file"</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">path</span><span class="w">    </span><span class="err">=</span><span class="w"> </span><span class="s2">"/mnt/vault/data"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>We need to also create this path with ```sudo mkdir /mnt/vault/data”.</p><p>And we can start our server with the command: <code class="language-plaintext highlighter-rouge">vault server -config=config.hcl</code></p><h3 id="2-vault-init">2. Vault init:</h3><p>After starting vault server we can access the website with basic ‘initialization’ <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://imgur.com/1qHRBzF.png" alt="init" /></p><p>It tells us to specify the number of key shares - These tokens will be used to the process of <em>unsealing vault</em> - each key should be owned by each person administrating the vault. Because It’s a local setup I’ll set each of the form input to ‘1’</p><p>After that: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://imgur.com/U210xK3.png" alt="init-success" /></p><p>I recommend downloading the file with keys, moving this file <strong>outside of your home folder</strong>, changing the owner of this file to root user with <code class="language-plaintext highlighter-rouge">chown root &lt;vault_key_file&gt;</code> and setting up permission to read-only with <code class="language-plaintext highlighter-rouge">chmod 400 &lt;vault_key_file&gt;</code></p><p>There’s also root key to login</p><h3 id="migrating-yeah">‘Migrating’… Yeah…</h3><p>I didn’t expect that to be honest, but we have to repeat the whole process of creating a user, adding policy again. To make things easier for you and myself I’ve created this simple bash script:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">export </span><span class="nv">VAULT_ADDR</span><span class="o">=</span><span class="s2">"http://127.0.0.1:8200"</span>
<span class="nb">export </span><span class="nv">VAULT_TOKEN</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">YOUR_CHOSEN_USERNAME</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">YOUR_CHOSEN_PASSWORD</span><span class="o">=</span><span class="s2">""</span> <span class="c"># ENTER YOUR PASSWORD HERE, OR ENVIRONMENT VARIABLE WHERE THE PASSWORD IS LOCATED</span>
<span class="nv">YOUR_EMAIL_HERE</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">YOUR_GITHUB_TOKEN_HERE</span><span class="o">=</span><span class="s2">""</span>


<span class="nb">echo</span> <span class="nv">$VAULT_TOKEN</span> | vault login -

vault auth <span class="nb">enable </span>userpass

vault policy write github - <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
path "secret/*" {
    capabilities = ["read", "list", "create", "update"]
}
</span><span class="no">EOF



</span>vault write auth/userpass/users/<span class="s2">"</span><span class="k">${</span><span class="nv">YOUR_CHOSEN_USERNAME</span><span class="k">}</span><span class="s2">"</span> <span class="nv">password</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">YOUR_CHOSEN_PASSWORD</span><span class="k">}</span><span class="s2">"</span> <span class="nv">policies</span><span class="o">=</span>github

vault secrets <span class="nb">enable</span> <span class="nt">-path</span><span class="o">=</span>secret/ kv

vault kv put secret/github/email <span class="nv">key</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">YOUR_EMAIL_HERE</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="nv">$VAULT_TOKEN</span>
vault kv put secret/github/GITHUB_TOKEN <span class="nv">key</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">YOUR_GITHUB_TOKEN_HERE</span><span class="k">}</span><span class="s2">"</span>

<span class="nb">unset </span>VAULT_TOKEN

vault login <span class="nt">-method</span><span class="o">=</span>userpass <span class="nv">username</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">YOUR_CHOSEN_USERNAME</span><span class="k">}</span><span class="s2">"</span>
</pre></table></code></div></div><p>After the execution of the script, <code class="language-plaintext highlighter-rouge">export VAULT_TOKEN=&lt;YOUR_USERNAME_TOKEN&gt;</code> and test it.</p><p>After testing remove the script completely (don’t forget the trash directory) or delete the hard-coded credentials</p><h2 id="integrating-it-with-a-bash-alias">Integrating it with a bash alias:</h2><p>One thing is missing from the Hashicorp’s documentation and that is - lack of setting up vault as systemd service. Fortunately I stumbled across this blog post:</p><p>https://blog.vivekv.com/hashicorp-vault-systemd-startup-script.html</p><p>We don’t need to do everything described in this blog. There are little to no steps:</p><ol><li>Open the file <code class="language-plaintext highlighter-rouge">/usr/lib/systemd/system/vault.service</code> and see the contents of it:</ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>[Unit]
Description=Vault server
Requires=basic.target network.target
After=basic.target network.target

[Service]
User=vault
Group=vault
PrivateTmp=yes
ProtectSystem=full
ProtectHome=read-only
CapabilityBoundingSet=CAP_IPC_LOCK
Environment=GOMAXPROCS=2
ExecStart=/bin/vault server -config=/etc/vault.hcl
KillSignal=SIGINT
TimeoutStopSec=30s
Restart=on-failure
StartLimitInterval=60s
StartLimitBurst=3

[Install]
WantedBy=multi-user.target
</pre></table></code></div></div><p>We want to replace the existing <code class="language-plaintext highlighter-rouge">/etc/vault.hcl</code> file with our config. with</p><p><code class="language-plaintext highlighter-rouge">sudo cp &lt;PATH_TO_OUR_CONFIG&gt; /etc/vault.hcl</code></p><ol><li><p>Execute <code class="language-plaintext highlighter-rouge">systemctl daemon-reload &amp;&amp; systemctl start vault &amp;&amp; systemctl enable vault</code></p><p>then check if it has successfully started with <code class="language-plaintext highlighter-rouge">systemctl status vault</code>. If it didn’t, then check the logs with: <code class="language-plaintext highlighter-rouge">sudo journalctl -u vault.service</code></p></ol><p>Also let’s add automatically export the <code class="language-plaintext highlighter-rouge">$VAULT_ADDR</code> variable. We could do that in <code class="language-plaintext highlighter-rouge">.bashrc</code>, <code class="language-plaintext highlighter-rouge">.bash_profile</code> or just like the author of the post did, place a bash script here -&gt;<code class="language-plaintext highlighter-rouge">/etc/profile.d/vault.sh</code> with the contents of:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nb">export </span><span class="nv">VAULT_ADDR</span><span class="o">=</span><span class="s1">'http://127.0.0.1:8200'</span>

</pre></table></code></div></div><p>Now let’s begin with automating the process of getting these keys, unfortunately, it’s hard to implement getting the keys automatically with <code class="language-plaintext highlighter-rouge">git push</code> command. We may get the idea of doing that later… For now though, let’s create an <strong>alias</strong> for the set of vault commands.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">function </span>gitgot<span class="o">(){</span>

	vault login <span class="nv">username</span><span class="o">=</span>&lt;YOUR_USERNAME_HERE&gt;
	vault kv get <span class="nt">-field</span><span class="o">=</span>key secret/github/email
	vault kv get <span class="nt">-field</span><span class="o">=</span>key secret/github/GITHUB_TOKEN
<span class="o">}</span>
</pre></table></code></div></div><p>Put this function inside a <code class="language-plaintext highlighter-rouge">.bash_profile</code> file or <code class="language-plaintext highlighter-rouge">.zprofile</code> file</p><p>Now when you start a new terminal, executing command <code class="language-plaintext highlighter-rouge">gitgot</code> should ask you for username and password, and if credentials were correct both email and GITHUB_TOKEN would be printed out.</p><p>We can also set caching of these credentials when doing <code class="language-plaintext highlighter-rouge">git push</code> to be around 4hours with command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git config <span class="nt">--global</span> credential.helper <span class="s1">'cache --timeout 14400'</span>
</pre></table></code></div></div><h2 id="caveats">Caveats:</h2><ul><li>We’ve used a default secrets path called <code class="language-plaintext highlighter-rouge">secret/github</code>. I’ve done that because I don’t see (yet!) another use-case of Hashicorp Vault on my daily basis workflow. However, If I had to manage more secrets and more API keys I would probably diverse these tokens to different profiles.</ul><p><strong>That’s it!</strong> It was seriously a long struggle for me, I personally encountered many issues with setting this up, and though It may not be perfect having vault implemented feels so satisfying! I hope you’ve also learned something and because that scenario is meant to run only locally maybe you’ll do the setup yourself :) Cheers.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/blog/categories/devsecops/'>DevSecOps</a>, <a href='/blog/categories/vault/'>Vault</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/blog/tags/vault/" class="post-tag no-text-decoration" >vault</a> <a href="/blog/tags/authentication/" class="post-tag no-text-decoration" >authentication</a> <a href="/blog/tags/key-management/" class="post-tag no-text-decoration" >key management</a> <a href="/blog/tags/api/" class="post-tag no-text-decoration" >api</a> <a href="/blog/tags/devsecops/" class="post-tag no-text-decoration" >devsecops</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Setting up Hashicorp Vault to manage our Github Token - Cloufish's Blog&url=https://cloufish.github.io/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Setting up Hashicorp Vault to manage our Github Token - Cloufish's Blog&u=https://cloufish.github.io/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Setting up Hashicorp Vault to manage our Github Token - Cloufish's Blog&url=https://cloufish.github.io/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/posts/Can-OWASP-ZAP-replace-Burp-Suite-Professional/">Can OWASP ZAP replace Burp Suite Professional?</a><li><a href="/blog/posts/OWASP-ZAP-as-a-great-fuzzing-tool/">OWASP-ZAP-Fuzzer is it a great alternative for Burp-Suite Intruder?</a><li><a href="/blog/posts/Setting-up-zap-scan-in-cicd-pipeline/">Setting up ZAP Scan in CI/CD pipeline</a><li><a href="/blog/posts/Setting-Up-Hashicorp-Vault-To-Manage-Github-Token/">Setting up Hashicorp Vault to manage our Github Token</a><li><a href="/blog/posts/Preventing-Insufficient-Logging-and-Monitoring/">Concept of Preventing Insufficient Logging & Monitoring</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/devsecops/">devsecops</a> <a class="post-tag" href="/blog/tags/beginner/">beginner</a> <a class="post-tag" href="/blog/tags/containers/">containers</a> <a class="post-tag" href="/blog/tags/docker/">docker</a> <a class="post-tag" href="/blog/tags/blog/">blog</a> <a class="post-tag" href="/blog/tags/cms/">cms</a> <a class="post-tag" href="/blog/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/blog/tags/owasp/">owasp</a> <a class="post-tag" href="/blog/tags/pentesting-lab/">pentesting lab</a> <a class="post-tag" href="/blog/tags/zaproxy/">zaproxy</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/posts/Setting-up-zap-scan-in-cicd-pipeline/"><div class="card-body"> <span class="timeago small" > Apr 12 <i class="unloaded">2021-04-12T07:46:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Setting up ZAP Scan in CI/CD pipeline</h3><div class="text-muted small"><p> What is CI/CD pipeline? To put it simply, it is a pathway to deployment, in a fast way in respect with Agile manifesto. Every pull request on GitHub should be checked in order to check if it’s work...</p></div></div></a></div><div class="card"> <a href="/blog/posts/Preventing-Insufficient-Logging-and-Monitoring/"><div class="card-body"> <span class="timeago small" > Apr 26 <i class="unloaded">2021-04-26T07:46:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Concept of Preventing Insufficient Logging & Monitoring</h3><div class="text-muted small"><p> Intro Security Breaches happen, and also you should be prepared for them to happen, expect them! With this mindset you can minimize the impact of the breach. With logging, we can be better prepare...</p></div></div></a></div><div class="card"> <a href="/blog/posts/Basics-Of-Kubernetes/"><div class="card-body"> <span class="timeago small" > May 3 <i class="unloaded">2021-05-03T07:46:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Basics of Kubernetes (Without Hands-on Practice)</h3><div class="text-muted small"><p> Intro: What I want you to know already: What are containers - I recommend this course -&gt; freeCodeCamp Docker How to create them in Dockerfiles, for that I recommend blackarch-zsh blog-post ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/posts/Setting-up-zap-scan-in-cicd-pipeline/" class="btn btn-outline-primary" prompt="Older"><p>Setting up ZAP Scan in CI/CD pipeline</p></a> <a href="/blog/posts/Preventing-Insufficient-Logging-and-Monitoring/" class="btn btn-outline-primary" prompt="Newer"><p>Concept of Preventing Insufficient Logging & Monitoring</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/cloufisz">Bartholomew Mokrzycki</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/blog/tags/devsecops/">devsecops</a> <a class="post-tag" href="/blog/tags/beginner/">beginner</a> <a class="post-tag" href="/blog/tags/containers/">containers</a> <a class="post-tag" href="/blog/tags/docker/">docker</a> <a class="post-tag" href="/blog/tags/blog/">blog</a> <a class="post-tag" href="/blog/tags/cms/">cms</a> <a class="post-tag" href="/blog/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/blog/tags/owasp/">owasp</a> <a class="post-tag" href="/blog/tags/pentesting-lab/">pentesting lab</a> <a class="post-tag" href="/blog/tags/zaproxy/">zaproxy</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/blog/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://cloufish.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
